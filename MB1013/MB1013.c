/*
 * MB1013.c
 *
 *  Created on: 07-Jun-2022
 *      Author: sidiyer27
 */

#include "MB1013.h"

void MB1013_Init(){

	RCC -> AHB1ENR   |= RCC_AHB1ENR_GPIOAEN;
	RCC -> AHB1ENR   |= RCC_AHB1ENR_GPIODEN;
	RCC -> AHB1ENR   |= RCC_AHB1ENR_GPIOEEN;

	//tim1 ch1 setup PE9
	GPIOE->MODER |= GPIO_MODER_MODE9_1;
	GPIOE -> AFR[1] |= GPIO_AFRH_AFSEL9_0;
	RCC->APB2ENR |= RCC_APB2ENR_TIM1EN;
	TIM1->PSC = 168-1;
	TIM1->CCMR1 |= TIM_CCMR1_CC1S_0 | TIM_CCMR1_IC1F_0 | TIM_CCMR1_IC1F_1;
	TIM1->CCMR1 |= TIM_CCMR1_CC2S_1 | TIM_CCMR1_IC2F_0 | TIM_CCMR1_IC2F_1;
	TIM1->CCER |= TIM_CCER_CC2P | TIM_CCER_CC1E | TIM_CCER_CC2E;
	TIM1->SMCR |= TIM_SMCR_TS_2 | TIM_SMCR_TS_0 | TIM_SMCR_SMS_2;
	TIM1->CR1 |= TIM_CR1_CEN;

	//tim2 ch1 setup PA5
	GPIOA->MODER |= GPIO_MODER_MODE5_1;
	GPIOA -> AFR[0] |= GPIO_AFRL_AFSEL5_0;
	RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;
	TIM2->PSC = 84-1;
	TIM2->CCMR1 |= TIM_CCMR1_CC1S_0 | TIM_CCMR1_IC1F_0 | TIM_CCMR1_IC1F_1;
	TIM2->CCMR1 |= TIM_CCMR1_CC2S_1 | TIM_CCMR1_IC2F_0 | TIM_CCMR1_IC2F_1;
	TIM2->CCER |= TIM_CCER_CC2P | TIM_CCER_CC1E | TIM_CCER_CC2E;
	TIM2->SMCR |= TIM_SMCR_TS_2 | TIM_SMCR_TS_0 | TIM_SMCR_SMS_2;
	TIM2->CR1 |= TIM_CR1_CEN;

	//tim3 ch1 setup PA6
	GPIOA->MODER |= GPIO_MODER_MODE6_1;
	GPIOA -> AFR[0] |= GPIO_AFRL_AFSEL6_1;
	RCC->APB1ENR |= RCC_APB1ENR_TIM3EN;
	TIM3->PSC = 84-1;
	TIM3->CCMR1 |= TIM_CCMR1_CC1S_0 | TIM_CCMR1_IC1F_0 | TIM_CCMR1_IC1F_1;
	TIM3->CCMR1 |= TIM_CCMR1_CC2S_1 | TIM_CCMR1_IC2F_0 | TIM_CCMR1_IC2F_1;
	TIM3->CCER |= TIM_CCER_CC2P | TIM_CCER_CC1E | TIM_CCER_CC2E;
	TIM3->SMCR |= TIM_SMCR_TS_2 | TIM_SMCR_TS_0 | TIM_SMCR_SMS_2;
	TIM3->CR1 |= TIM_CR1_CEN;

	//tim4 ch1 setup PD12
	GPIOD->MODER |= GPIO_MODER_MODE12_1;
	GPIOD->AFR[1]|= GPIO_AFRH_AFSEL12_1;
	RCC->APB1ENR |= RCC_APB1ENR_TIM4EN;
	TIM4->PSC = 84-1;
	TIM4->CCMR1 |= TIM_CCMR1_CC1S_0 | TIM_CCMR1_IC1F_0 | TIM_CCMR1_IC1F_1;
	TIM4->CCMR1 |= TIM_CCMR1_CC2S_1 | TIM_CCMR1_IC2F_0 | TIM_CCMR1_IC2F_1;
	TIM4->CCER |= TIM_CCER_CC2P | TIM_CCER_CC1E | TIM_CCER_CC2E;
	TIM4->SMCR |= TIM_SMCR_TS_2 | TIM_SMCR_TS_0 | TIM_SMCR_SMS_2;
	TIM4->CR1 |= TIM_CR1_CEN;

	//tim5 ch1 setup PA0
	GPIOA->MODER |= GPIO_MODER_MODE0_1;
	GPIOA -> AFR[0] |= GPIO_AFRL_AFSEL0_1;
	RCC->APB1ENR |= RCC_APB1ENR_TIM5EN;
	TIM5->PSC = 84-1;
	TIM5->CCMR1 |= TIM_CCMR1_CC1S_0 | TIM_CCMR1_IC1F_0 | TIM_CCMR1_IC1F_1;
	TIM5->CCMR1 |= TIM_CCMR1_CC2S_1 | TIM_CCMR1_IC2F_0 | TIM_CCMR1_IC2F_1;
	TIM5->CCER |= TIM_CCER_CC2P | TIM_CCER_CC1E | TIM_CCER_CC2E;
	TIM5->SMCR |= TIM_SMCR_TS_2 | TIM_SMCR_TS_0 | TIM_SMCR_SMS_2;
	TIM5->CR1 |= TIM_CR1_CEN;

	//tim9 ch1 setup PE5
	GPIOE->MODER |= GPIO_MODER_MODE5_1;
	GPIOE -> AFR[0] |= GPIO_AFRL_AFSEL5_1 | GPIO_AFRL_AFSEL5_0;
	RCC->APB2ENR |= RCC_APB2ENR_TIM9EN;
	TIM9->PSC = 168-1;
	TIM9->CCMR1 |= TIM_CCMR1_CC1S_0 | TIM_CCMR1_IC1F_0 | TIM_CCMR1_IC1F_1;
	TIM9->CCMR1 |= TIM_CCMR1_CC2S_1 | TIM_CCMR1_IC2F_0 | TIM_CCMR1_IC2F_1;
	TIM9->CCER |= TIM_CCER_CC2P | TIM_CCER_CC1E | TIM_CCER_CC2E;
	TIM9->SMCR |= TIM_SMCR_TS_2 | TIM_SMCR_TS_0 | TIM_SMCR_SMS_2;
	TIM9->CR1 |= TIM_CR1_CEN;
}



uint8_t MB1013_Array(uint16_t threshold){
	uint8_t ret = 0;
	if(TIM1->CCR2 <= threshold){
		ret |= 1<<5;
	}
	if(TIM2->CCR2 <= threshold){
		ret |= 1<<4;
	}
	if(TIM3->CCR2 <= threshold){
		ret |= 1<<3;
	}
	if(TIM4->CCR2 <= threshold){
		ret |= 1<<2;
	}
	if(TIM5->CCR2 <= threshold){
		ret |= 1<<1;
	}
	if(TIM9->CCR2 <= threshold){
		ret |= 1<<0;
	}

	return ret;
}
bool MB1013_Threshold(int sensoridx, float dist){

	if(MB1013_Dist(sensoridx) >= dist){
		return true;
	}
	else{
		return false;
	}

}



uint32_t MB1013_Dist_MM(int sensoridx){
	if(sensoridx == 1){
		return TIM1->CCR2;
	}
	if(sensoridx == 2){
		return TIM2->CCR2;
	}
	if(sensoridx == 3){
		return TIM3->CCR2;
	}
	if(sensoridx == 4){
		return TIM4->CCR2;
	}
	if(sensoridx == 5){
		return TIM5->CCR2;
	}
	if(sensoridx == 6){
		return TIM9->CCR2;
	}
}

float MB1013_Dist_CM(int sensoridx){
	return MB1013_Dist(sensoridx)/100;
}
float MB1013_Dist_M(int sensoridx){
	return MB1013_Dist(sensoridx)/1000;
}


